---
import Base from '../../layouts/Base.astro';
import { getArtists, getArtistBySlug, getForms, getFestivals, splitSemicolon, isActive } from '../../lib/supabase';

export async function getStaticPaths() {
  const artists = await getArtists();
  return artists.map(a => ({ params: { slug: a.slug } }));
}

const { slug } = Astro.params;
const artist = await getArtistBySlug(slug!);
if (!artist) return Astro.redirect('/performers');

const [allForms, allFestivals] = await Promise.all([getForms(), getFestivals()]);
const artistFormNames = splitSemicolon(artist.performance_forms);
const artistForms = allForms.filter(f => artistFormNames.some(af => af.toLowerCase() === f.name.toLowerCase()));
const cityFestivals = allFestivals.filter(f => f.city.toLowerCase() === artist.base_city.toLowerCase());
const active = isActive(artist);

const typeIcon: Record<string, string> = { 'SOLO': '◆', 'GROUP': '◇', 'ENSEMBLE': '○', 'DUO': '◈' };

const personSchema = {
  "@context": "https://schema.org", "@type": active ? "Person" : "Person",
  "name": artist.name, "alternateName": artist.name_ar || undefined,
  "description": artist.biography,
  "birthPlace": { "@type": "Place", "name": artist.base_city + ", Morocco" },
  ...(artist.active_since ? { "birthDate": String(artist.active_since) } : {}),
  "nationality": { "@type": "Country", "name": "Morocco" },
  "knowsAbout": artistFormNames,
};

const faqSchema = {
  "@context": "https://schema.org", "@type": "FAQPage",
  "mainEntity": [
    { "@type": "Question", "name": `Who is ${artist.name}?`, "acceptedAnswer": { "@type": "Answer", "text": artist.biography } },
    { "@type": "Question", "name": `What music does ${artist.name} perform?`, "acceptedAnswer": { "@type": "Answer", "text": `${artist.name} performs ${artistFormNames.join(', ')}. Based in ${artist.base_city}, Morocco.` } },
  ],
};
---

<Base title={`${artist.name} — Music in Morocco`} description={artist.biography?.slice(0, 160)}>
  <script type="application/ld+json" set:html={JSON.stringify(personSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />

  <div class="section-inner">
    <div class="page-header">
      <span class="micro-label">{typeIcon[artist.type] || '◆'} {artist.type}</span>
      <h1>{artist.name}</h1>
      {artist.name_ar && <p class="name-ar">{artist.name_ar}</p>}
    </div>

    <!-- Info card -->
    <div class="info-grid">
      {artist.base_city && <div class="info-item"><span class="info-label">Base</span><span>{artist.base_city}, {artist.region}</span></div>}
      {artist.active_since && <div class="info-item"><span class="info-label">Active since</span><span>{artist.active_since}</span></div>}
      <div class="info-item"><span class="info-label">Status</span><span>{artist.status}</span></div>
      <div class="info-item"><span class="info-label">Traditions</span><div class="tag-row">{artistFormNames.map(f => <a href={`/forms/${f.toLowerCase().replace(/\s+/g, '-')}`} class="tag">{f}</a>)}</div></div>
    </div>

    <!-- Biography -->
    {artist.biography && (
      <section class="bio-section">
        <h2>Biography</h2>
        <p>{artist.biography}</p>
      </section>
    )}

    <!-- Related forms -->
    {artistForms.length > 0 && (
      <section class="related-section">
        <h2>Performance Traditions</h2>
        <div class="related-list">
          {artistForms.map(f => (
            <a href={`/forms/${f.slug}`} class="related-row">
              <span class="r-cat">{f.category}</span>
              <span class="r-name">{f.name}</span>
              <span class="r-desc">{f.description?.slice(0, 80)}…</span>
            </a>
          ))}
        </div>
      </section>
    )}

    <!-- Festivals in city -->
    {cityFestivals.length > 0 && (
      <section class="related-section">
        <h2>Festivals in {artist.base_city}</h2>
        <div class="related-list">
          {cityFestivals.map(f => (
            <a href={`/festivals/${f.slug}`} class="related-row">
              <span class="r-cat">{f.frequency}</span>
              <span class="r-name">{f.name}</span>
              <span class="r-desc">{splitSemicolon(f.performance_forms).join(', ')}</span>
            </a>
          ))}
        </div>
      </section>
    )}
  </div>
</Base>

<style>
  .name-ar { font-size: 1.2rem; color: var(--color-ink-muted); direction: rtl; margin-top: 0.2rem; }

  .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0; border: 1px solid var(--color-border); margin-bottom: var(--space-md); }
  .info-item { padding: 0.6rem 0.8rem; border-bottom: 1px solid var(--color-border); }
  .info-label { display: block; font-size: 0.55rem; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--color-ink-muted); margin-bottom: 0.1rem; }
  .info-item span:not(.info-label) { font-size: 0.85rem; }
  .tag-row { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.15rem; }
  .tag { font-size: 0.6rem; font-weight: 500; letter-spacing: 0.06em; padding: 0.1rem 0.35rem; border: 1px solid var(--color-border); color: var(--color-ink-light); transition: border-color 0.15s; }
  .tag:hover { border-color: var(--color-ink); }

  .bio-section { margin-bottom: var(--space-md); }
  .bio-section h2 { font-family: var(--font-display); font-size: 1.3rem; margin-bottom: 0.5rem; }
  .bio-section p { font-size: 0.9rem; font-weight: 300; line-height: 1.6; color: var(--color-ink-light); max-width: 700px; }

  .related-section { margin-bottom: var(--space-md); }
  .related-section h2 { font-family: var(--font-display); font-size: 1.3rem; margin-bottom: 0.5rem; padding-bottom: 0.3rem; border-bottom: 1px solid var(--color-border); }
  .related-list { display: flex; flex-direction: column; }
  .related-row { display: grid; grid-template-columns: 80px 1fr 1fr; gap: 1rem; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border); align-items: baseline; transition: padding-left 0.15s; }
  .related-row:hover { padding-left: 0.4rem; }
  .r-cat { font-size: 0.55rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-ink-muted); }
  .r-name { font-family: var(--font-display); font-size: 0.95rem; }
  .r-desc { font-size: 0.72rem; font-weight: 300; color: var(--color-ink-muted); }

  @media (max-width: 640px) {
    .related-row { grid-template-columns: 1fr; gap: 0.1rem; }
  }
</style>
