---
import Base from '../layouts/Base.astro';
import { getArtists, getForms, getFestivals, getCities, getInstruments, isActive, splitSemicolon } from '../lib/supabase';

const [artists, forms, festivals, cities, instruments] = await Promise.all([
  getArtists(), getForms(), getFestivals(), getCities(), getInstruments(),
]);

const activeArtists = artists.filter(isActive);
const activeFestivals = festivals.filter(f => f.status?.toLowerCase() === 'active');

const faqSchema = {
  "@context": "https://schema.org", "@type": "FAQPage",
  "mainEntity": [
    { "@type": "Question", "name": "What is Gnawa music?", "acceptedAnswer": { "@type": "Answer", "text": "Gnawa is a spiritual music tradition of sub-Saharan origin practised in Morocco combining Islamic Sufi practices with pre-Islamic African traditions. UNESCO inscribed Gnawa in 2019." } },
    { "@type": "Question", "name": "What are the main music traditions of Morocco?", "acceptedAnswer": { "@type": "Answer", "text": `Morocco has ${forms.length} documented performance traditions spanning music, dance, and ritual — including Gnawa, Ahwach, Ahidous, Andalusi, Aita, Malhun, Dakka Marrakchia, Rwais, Taskiwin, and Chaabi.` } },
    { "@type": "Question", "name": "Who are the most famous Moroccan musicians?", "acceptedAnswer": { "@type": "Answer", "text": `Music in Morocco documents ${artists.length} performers including Maalem Mahmoud Guinea, Nass El Ghiwane, Fatima Tabaamrant, Hajja El Hamdaouia, and Hamid El Kasri.` } },
    { "@type": "Question", "name": "What are the best music festivals in Morocco?", "acceptedAnswer": { "@type": "Answer", "text": `Morocco hosts ${festivals.length} major music festivals including the Gnaoua World Music Festival in Essaouira and the Fes Festival of World Sacred Music.` } },
    { "@type": "Question", "name": "What instruments are used in Moroccan music?", "acceptedAnswer": { "@type": "Answer", "text": `Moroccan music uses ${instruments.length} traditional instruments including the guembri, qraqeb, bendir, oud, kamanja, darbuka, and tbel.` } },
  ],
};
---

<Base title="Music in Morocco — Performers, Traditions & Festivals">
  <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />

  <section class="hero">
    <div class="hero-inner">
      <h1>Music in<br><em>Morocco</em></h1>
      <p class="hero-sub">{artists.length} artists · {forms.length} traditions · {instruments.length} instruments · {festivals.length} festivals · {cities.length} cities</p>
      <p class="hero-desc">Music, dance, and ritual — a complete reference for Moroccan performance traditions from Gnawa trance ceremonies to Ahwach collective dance to Rwais poetry.</p>
    </div>
  </section>

  <!-- Traditions -->
  <div class="section-inner">
    <div class="sh"><span class="micro-label">Traditions</span><h2>Performance Forms</h2><a href="/forms" class="va">View all →</a></div>
    <div class="form-grid">
      {forms.slice(0, 8).map(form => (
        <a href={`/forms/${form.slug}`} class="form-card">
          <span class="fc-cat">{form.category}</span>
          <h3>{form.name}</h3>
          {form.name_ar && <span class="arabic">{form.name_ar}</span>}
          <p>{form.description?.slice(0, 100)}…</p>
          {form.unesco_status && <span class="badge">★ {form.unesco_status}</span>}
        </a>
      ))}
    </div>
  </div>

  <!-- Artists — dark band -->
  <section class="dark-band">
    <div class="dark-inner">
      <div class="sh"><span class="micro-label" style="color:rgba(255,255,255,0.5)">Directory</span><h2 style="color:white">Artists</h2><a href="/performers" class="va" style="color:rgba(255,255,255,0.6)">View all →</a></div>
      <div class="artist-rows">
        {activeArtists.slice(0, 12).map(a => (
          <a href={`/performers/${a.slug}`} class="ar-row">
            <span class="ar-type">{a.type}</span>
            <span class="ar-name">{a.name}</span>
            <span class="ar-forms">{splitSemicolon(a.performance_forms).join(', ')}</span>
            <span class="ar-city">{a.base_city}</span>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Instruments -->
  <div class="section-inner">
    <div class="sh"><span class="micro-label">Instruments</span><h2>Traditional Instruments</h2><a href="/instruments" class="va">View all →</a></div>
    <div class="inst-grid">
      {instruments.slice(0, 6).map(inst => (
        <a href={`/instruments/${inst.slug}`} class="inst-card">
          <span class="inst-fam">{inst.family}</span>
          <h3>{inst.name}</h3>
          {inst.name_ar && <span class="arabic">{inst.name_ar}</span>}
          <p>{inst.description?.slice(0, 80)}…</p>
        </a>
      ))}
    </div>
  </div>

  <!-- Festivals -->
  <div class="section-inner">
    <div class="sh"><span class="micro-label">Events</span><h2>Festivals</h2><a href="/festivals" class="va">View all →</a></div>
    <div class="fest-list">
      {activeFestivals.slice(0, 8).map(f => (
        <a href={`/festivals/${f.slug}`} class="fest-row">
          <span class="fest-city">{f.city}</span>
          <span class="fest-name">{f.name}</span>
          <span class="fest-forms">{splitSemicolon(f.performance_forms).join(', ')}</span>
        </a>
      ))}
    </div>
  </div>
</Base>

<style>
  .hero { background: #111; color: white; padding: var(--space-xl) var(--space-md); }
  .hero-inner { max-width: 1200px; margin: 0 auto; }
  .hero h1 { font-family: var(--font-display); font-size: clamp(3rem, 8vw, 6rem); font-weight: 400; line-height: 0.95; letter-spacing: -0.03em; }
  .hero h1 em { font-style: italic; }
  .hero-sub { font-size: 0.72rem; font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(255,255,255,0.5); margin-top: 1rem; }
  .hero-desc { font-size: 1rem; font-weight: 300; color: rgba(255,255,255,0.7); max-width: 500px; margin-top: 0.6rem; }

  .sh { display: flex; align-items: baseline; gap: 1rem; padding-bottom: var(--space-sm); border-bottom: 1px solid var(--color-border); margin-bottom: var(--space-md); flex-wrap: wrap; }
  .sh h2 { font-family: var(--font-display); font-size: 1.8rem; font-weight: 400; flex-grow: 1; }
  .va { font-size: 0.65rem; font-weight: 500; letter-spacing: 0.06em; color: var(--color-ink-muted); transition: color 0.15s; }
  .va:hover { color: var(--color-ink); }

  .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1px; background: var(--color-border); }
  .form-card { background: var(--color-bg); padding: var(--space-sm); transition: padding-left 0.15s; }
  .form-card:hover { padding-left: 1.3rem; }
  .fc-cat { font-size: 0.55rem; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--color-ink-muted); }
  .form-card h3 { font-family: var(--font-display); font-size: 1.15rem; margin-top: 0.15rem; }
  .arabic { font-size: 0.85rem; color: var(--color-ink-muted); direction: rtl; display: block; }
  .form-card p { font-size: 0.78rem; font-weight: 300; color: var(--color-ink-light); line-height: 1.4; margin-top: 0.3rem; }
  .badge { display: inline-block; font-size: 0.55rem; font-weight: 600; letter-spacing: 0.06em; padding: 0.15rem 0.4rem; border: 1px solid var(--color-border); color: var(--color-ink-muted); margin-top: 0.4rem; }

  .dark-band { background: #111; padding: var(--space-lg) 0; }
  .dark-inner { max-width: 1200px; margin: 0 auto; padding: 0 var(--space-md); }
  .dark-band .sh { border-color: rgba(255,255,255,0.15); }
  .artist-rows { display: flex; flex-direction: column; }
  .ar-row { display: grid; grid-template-columns: 70px 1fr 1fr auto; gap: 1rem; padding: 0.6rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); align-items: baseline; transition: padding-left 0.15s; color: white; }
  .ar-row:hover { padding-left: 0.4rem; }
  .ar-type { font-size: 0.55rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(255,255,255,0.4); }
  .ar-name { font-family: var(--font-display); font-size: 1rem; }
  .ar-forms { font-size: 0.72rem; font-weight: 300; color: rgba(255,255,255,0.5); }
  .ar-city { font-size: 0.65rem; color: rgba(255,255,255,0.4); text-align: right; }

  .inst-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1px; background: var(--color-border); }
  .inst-card { background: var(--color-bg); padding: var(--space-sm); transition: padding-left 0.15s; }
  .inst-card:hover { padding-left: 1.3rem; }
  .inst-fam { font-size: 0.55rem; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--color-ink-muted); }
  .inst-card h3 { font-family: var(--font-display); font-size: 1.05rem; margin-top: 0.1rem; }
  .inst-card p { font-size: 0.75rem; font-weight: 300; color: var(--color-ink-light); line-height: 1.4; margin-top: 0.2rem; }

  .fest-list { display: flex; flex-direction: column; }
  .fest-row { display: grid; grid-template-columns: 120px 1fr auto; gap: 1rem; padding: 0.55rem 0; border-bottom: 1px solid var(--color-border); align-items: baseline; transition: padding-left 0.15s; }
  .fest-row:hover { padding-left: 0.4rem; }
  .fest-city { font-size: 0.6rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--color-ink-muted); }
  .fest-name { font-family: var(--font-display); font-size: 1rem; }
  .fest-forms { font-size: 0.72rem; font-weight: 300; color: var(--color-ink-muted); }

  @media (max-width: 640px) {
    .ar-row { grid-template-columns: 1fr; gap: 0.15rem; }
    .fest-row { grid-template-columns: 1fr; gap: 0.15rem; }
  }
</style>
