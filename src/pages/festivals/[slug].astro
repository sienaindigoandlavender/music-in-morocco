---
import Base from '../../layouts/Base.astro';
import { getFestivals, getFestivalBySlug, getForms, getArtistsByCity, splitSemicolon } from '../../lib/supabase';

export async function getStaticPaths() {
  const festivals = await getFestivals();
  return festivals.map(f => ({ params: { slug: f.slug } }));
}

const { slug } = Astro.params;
const festival = await getFestivalBySlug(slug!);
if (!festival) return Astro.redirect('/festivals');

const [allForms, cityArtists] = await Promise.all([
  getForms(),
  getArtistsByCity(festival.city),
]);

const festFormNames = splitSemicolon(festival.performance_forms);
const festForms = allForms.filter(f => festFormNames.some(ff => ff.toLowerCase() === f.name.toLowerCase()));
const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

const faqSchema = {
  "@context": "https://schema.org", "@type": "FAQPage",
  "mainEntity": [
    { "@type": "Question", "name": `What is the ${festival.name}?`, "acceptedAnswer": { "@type": "Answer", "text": festival.description } },
    { "@type": "Question", "name": `When is the ${festival.name}?`, "acceptedAnswer": { "@type": "Answer", "text": `The ${festival.name} is held ${festival.frequency?.toLowerCase()} in ${festival.city}${festival.start_month ? `, typically in ${months[festival.start_month]}` : ''}.${festival.founded_year ? ` Founded in ${festival.founded_year}.` : ''}` } },
  ],
};

const eventSchema = {
  "@context": "https://schema.org", "@type": "MusicFestival",
  "name": festival.name, "alternateName": festival.name_ar || undefined,
  "description": festival.description,
  "location": { "@type": "Place", "name": festival.city + ", Morocco", "address": { "@type": "PostalAddress", "addressLocality": festival.city, "addressCountry": "MA" } },
  ...(festival.founded_year ? { "foundingDate": String(festival.founded_year) } : {}),
};
---

<Base title={`${festival.name} — Music in Morocco`} description={festival.description?.slice(0, 160)}>
  <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(eventSchema)} />

  <div class="section-inner">
    <div class="page-header">
      <span class="micro-label">{festival.city} · {festival.status}</span>
      <h1>{festival.name}</h1>
      {festival.name_ar && <p class="name-ar">{festival.name_ar}</p>}
    </div>

    <div class="info-grid">
      <div class="info-item"><span class="info-label">City</span><span><a href={`/cities/${festival.city.toLowerCase().replace(/\s+/g, '-')}`}>{festival.city}</a></span></div>
      <div class="info-item"><span class="info-label">Frequency</span><span>{festival.frequency}</span></div>
      {festival.start_month && <div class="info-item"><span class="info-label">Month</span><span>{months[festival.start_month]}</span></div>}
      {festival.founded_year && <div class="info-item"><span class="info-label">Founded</span><span>{festival.founded_year}</span></div>}
      <div class="info-item"><span class="info-label">Status</span><span>{festival.status}</span></div>
    </div>

    <section class="desc"><p>{festival.description}</p></section>

    {festForms.length > 0 && (
      <section class="rel">
        <h2>Featured Traditions</h2>
        <div class="rel-list">
          {festForms.map(f => (
            <a href={`/forms/${f.slug}`} class="rel-row">
              <span class="rl-cat">{f.category}</span>
              <span class="rl-name">{f.name}</span>
              <span class="rl-desc">{f.origin_region}</span>
            </a>
          ))}
        </div>
      </section>
    )}

    {cityArtists.length > 0 && (
      <section class="rel">
        <h2>Artists in {festival.city}</h2>
        <div class="rel-list">
          {cityArtists.map(a => (
            <a href={`/performers/${a.slug}`} class="rel-row">
              <span class="rl-cat">{a.type}</span>
              <span class="rl-name">{a.name}</span>
              <span class="rl-desc">{splitSemicolon(a.performance_forms).join(', ')}</span>
            </a>
          ))}
        </div>
      </section>
    )}
  </div>
</Base>

<style>
  .name-ar { font-size: 1.2rem; color: var(--color-ink-muted); direction: rtl; margin-top: 0.2rem; }
  .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0; border: 1px solid var(--color-border); margin-bottom: var(--space-md); }
  .info-item { padding: 0.6rem 0.8rem; border-bottom: 1px solid var(--color-border); }
  .info-label { display: block; font-size: 0.55rem; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--color-ink-muted); margin-bottom: 0.1rem; }
  .info-item span:not(.info-label) { font-size: 0.85rem; }
  .info-item a { border-bottom: 1px solid var(--color-border); }
  .desc { margin-bottom: var(--space-md); }
  .desc p { font-size: 0.92rem; font-weight: 300; line-height: 1.65; color: var(--color-ink-light); max-width: 700px; }
  .rel { margin-bottom: var(--space-md); }
  .rel h2 { font-family: var(--font-display); font-size: 1.3rem; margin-bottom: 0.5rem; padding-bottom: 0.3rem; border-bottom: 1px solid var(--color-border); }
  .rel-list { display: flex; flex-direction: column; }
  .rel-row { display: grid; grid-template-columns: 90px 1fr 1fr; gap: 1rem; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border); align-items: baseline; transition: padding-left 0.15s; }
  .rel-row:hover { padding-left: 0.4rem; }
  .rl-cat { font-size: 0.55rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-ink-muted); }
  .rl-name { font-family: var(--font-display); font-size: 0.95rem; }
  .rl-desc { font-size: 0.72rem; font-weight: 300; color: var(--color-ink-muted); }
  @media (max-width: 640px) { .rel-row { grid-template-columns: 1fr; gap: 0.1rem; } }
</style>
