---
import Base from '../../layouts/Base.astro';
import { getForms, getFormBySlug, getArtistsByForm, getFestivalsByForm, getInstruments, splitSemicolon } from '../../lib/supabase';

export async function getStaticPaths() {
  const forms = await getForms();
  return forms.map(f => ({ params: { slug: f.slug } }));
}

const { slug } = Astro.params;
const form = await getFormBySlug(slug!);
if (!form) return Astro.redirect('/forms');

const [performers, festivals, allInstruments] = await Promise.all([
  getArtistsByForm(form.name),
  getFestivalsByForm(form.name),
  getInstruments(),
]);

const formInstrumentNames = splitSemicolon(form.instruments);
const formInstruments = allInstruments.filter(i => formInstrumentNames.some(fi => fi.toLowerCase() === i.name.toLowerCase()));
const contexts = splitSemicolon(form.context);
const seasons = splitSemicolon(form.season);

const faqSchema = {
  "@context": "https://schema.org", "@type": "FAQPage",
  "mainEntity": [
    { "@type": "Question", "name": `What is ${form.name}?`, "acceptedAnswer": { "@type": "Answer", "text": form.description } },
    { "@type": "Question", "name": `What instruments are used in ${form.name}?`, "acceptedAnswer": { "@type": "Answer", "text": `${form.name} uses ${formInstrumentNames.join(', ')}.` } },
    { "@type": "Question", "name": `Who are the most famous ${form.name} performers?`, "acceptedAnswer": { "@type": "Answer", "text": `Notable ${form.name} performers include ${performers.slice(0, 5).map(p => p.name).join(', ')}.` } },
  ],
};
---

<Base title={`${form.name} — Music in Morocco`} description={form.description?.slice(0, 160)}>
  <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />

  <div class="section-inner">
    <div class="page-header">
      <span class="micro-label">{form.category}</span>
      <h1>{form.name}</h1>
      {form.name_ar && <p class="name-ar">{form.name_ar}</p>}
    </div>

    <div class="info-grid">
      <div class="info-item"><span class="info-label">Category</span><span>{form.category}</span></div>
      <div class="info-item"><span class="info-label">Origin</span><span>{form.origin_region}</span></div>
      {form.unesco_status && <div class="info-item"><span class="info-label">UNESCO</span><span>★ {form.unesco_status}</span></div>}
      {contexts.length > 0 && <div class="info-item"><span class="info-label">Context</span><span>{contexts.join(', ')}</span></div>}
      {seasons.length > 0 && <div class="info-item"><span class="info-label">Season</span><span>{seasons.join(', ')}</span></div>}
    </div>

    <section class="desc-section">
      <p>{form.description}</p>
    </section>

    {formInstruments.length > 0 && (
      <section class="rel">
        <h2>Instruments</h2>
        <div class="rel-list">
          {formInstruments.map(i => (
            <a href={`/instruments/${i.slug}`} class="rel-row">
              <span class="rl-cat">{i.family}</span>
              <span class="rl-name">{i.name}</span>
              <span class="rl-desc">{i.description?.slice(0, 80)}…</span>
            </a>
          ))}
        </div>
      </section>
    )}

    {performers.length > 0 && (
      <section class="rel">
        <h2>Performers</h2>
        <div class="rel-list">
          {performers.map(p => (
            <a href={`/performers/${p.slug}`} class="rel-row">
              <span class="rl-cat">{p.type}</span>
              <span class="rl-name">{p.name}</span>
              <span class="rl-desc">{p.base_city}</span>
            </a>
          ))}
        </div>
      </section>
    )}

    {festivals.length > 0 && (
      <section class="rel">
        <h2>Festivals</h2>
        <div class="rel-list">
          {festivals.map(f => (
            <a href={`/festivals/${f.slug}`} class="rel-row">
              <span class="rl-cat">{f.city}</span>
              <span class="rl-name">{f.name}</span>
              <span class="rl-desc">{f.frequency}</span>
            </a>
          ))}
        </div>
      </section>
    )}
  </div>
</Base>

<style>
  .name-ar { font-size: 1.2rem; color: var(--color-ink-muted); direction: rtl; margin-top: 0.2rem; }
  .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0; border: 1px solid var(--color-border); margin-bottom: var(--space-md); }
  .info-item { padding: 0.6rem 0.8rem; border-bottom: 1px solid var(--color-border); }
  .info-label { display: block; font-size: 0.55rem; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--color-ink-muted); margin-bottom: 0.1rem; }
  .info-item span:not(.info-label) { font-size: 0.85rem; }
  .desc-section { margin-bottom: var(--space-md); }
  .desc-section p { font-size: 0.92rem; font-weight: 300; line-height: 1.65; color: var(--color-ink-light); max-width: 700px; }
  .rel { margin-bottom: var(--space-md); }
  .rel h2 { font-family: var(--font-display); font-size: 1.3rem; margin-bottom: 0.5rem; padding-bottom: 0.3rem; border-bottom: 1px solid var(--color-border); }
  .rel-list { display: flex; flex-direction: column; }
  .rel-row { display: grid; grid-template-columns: 90px 1fr 1fr; gap: 1rem; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border); align-items: baseline; transition: padding-left 0.15s; }
  .rel-row:hover { padding-left: 0.4rem; }
  .rl-cat { font-size: 0.55rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-ink-muted); }
  .rl-name { font-family: var(--font-display); font-size: 0.95rem; }
  .rl-desc { font-size: 0.72rem; font-weight: 300; color: var(--color-ink-muted); }
  @media (max-width: 640px) { .rel-row { grid-template-columns: 1fr; gap: 0.1rem; } }
</style>
